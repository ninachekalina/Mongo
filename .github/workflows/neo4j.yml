name: Neo4j CI

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/neo4j.yml'
      - 'test_queries_neo4j.cql'
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/neo4j.yml'
      - 'test_queries_neo4j.cql'
  workflow_dispatch:

jobs:
  test-neo4j:
    runs-on: ubuntu-latest
    services:
      neo4j:
        image: neo4j:5.10
        ports:
          - 7474:7474
          - 7687:7687
        env:
          NEO4J_AUTH: none
        options: >-
          --health-cmd "cypher-shell -u neo4j -p test 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Cypher Shell
        run: |
          wget -qO cypher-shell.deb https://dist.neo4j.org/cypher-shell/cypher-shell_5.10.0_all.deb || \
          wget -qO cypher-shell.deb https://github.com/neo4j/cypher-shell/releases/download/1.1.15/cypher-shell_1.1.15_all.deb
          sudo dpkg -i cypher-shell.deb
          rm cypher-shell.deb

      - name: Check Neo4j CLI version
        run: cypher-shell --version

      - name: List running containers
        run: docker ps -a

      - name: Check running processes
        run: sudo netstat -tulnp  # Проверка портов

      - name: Wait for Neo4j to be ready
        run: |
          echo "Waiting for Neo4j service..."
          sleep 5
          for i in {1..30}; do
            STATUS=$(docker inspect --format="{{.State.Health.Status}}" $(docker ps -q --filter "ancestor=neo4j:5.10") 2>/dev/null)
            if [[ "$STATUS" == "healthy" ]]; then
              echo "Neo4j is ready!"
              exit 0
            fi
            echo "Waiting for Neo4j to start ($i/30)..."
            sleep 5
          done
          echo "Neo4j did not start in time."
          docker logs $(docker ps -q --filter "ancestor=neo4j:5.10")
          exit 1

      - name: Debug Neo4j Logs
        run: docker logs $(docker ps -q --filter "ancestor=neo4j:5.10")

      - name: Download Netflix dataset from Kaggle
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          pip install kaggle
          mkdir -p data
          kaggle datasets download -d chekalinanina/netflix-titles -p data --unzip

      - name: Run Cypher queries
        run: |
          #cypher-shell -a bolt://localhost:7687 -u neo4j -p test 'CREATE (:Movie {title: "Inception", release_year: 2010});'
          #cypher-shell -a bolt://localhost:7687 -u neo4j -p test 'CREATE (:Actor {name: "Leonardo DiCaprio"});'
          #cypher-shell -a bolt://localhost:7687 -u neo4j -p test 'MATCH (m:Movie {title: "Inception"}), (a:Actor {name: "Leonardo DiCaprio"}) CREATE (a)-[:ACTED_IN]->(m);'
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) RETURN s.title, s.type LIMIT 10;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) WHERE s.type = 'Movie' RETURN s.title LIMIT 10;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) RETURN s.listed_in, COUNT(*) AS count ORDER BY count DESC;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) RETURN s.rating, COUNT(*) AS count ORDER BY count DESC;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) WHERE s.release_year > 2015 RETURN s.title, s.release_year;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) WHERE s.rating = 'PG-13' RETURN s.title;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (a:Actor)-[:ACTED_IN]->(m:Movie) RETURN a.name, COUNT(m) AS movies ORDER BY movies DESC;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) WHERE s.duration IS NOT NULL RETURN avg(toInteger(s.duration)) AS avg_duration;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) WHERE s.country = 'United States' RETURN s.title LIMIT 5;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) RETURN s.release_year, COUNT(*) AS count ORDER BY count DESC;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) WHERE s.director IS NULL RETURN s.title LIMIT 5;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) RETURN s.country, COUNT(*) AS count ORDER BY count DESC;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) RETURN s.listed_in, avg(toInteger(s.duration)) AS avg_duration ORDER BY avg_duration DESC;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) WHERE s.release_year = 2021 RETURN COUNT(s);"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) WHERE s.description IS NOT NULL RETURN s.description ORDER BY length(s.description) DESC LIMIT 5;"
          cypher-shell -a bolt://localhost:7687l -u neo4j -p test "MATCH (s:Show) RETURN s.title ORDER BY toInteger(s.duration) DESC LIMIT 5;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (a:Actor)-[:ACTED_IN]->(m:Movie) RETURN a.name, collect(m.title) LIMIT 5;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show) RETURN count(*) AS total_count;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show)-[:LISTED_IN]->(g:Genre) RETURN g.name, COUNT(s) ORDER BY COUNT(s) DESC LIMIT 5;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show)-[:LISTED_IN]->(g:Genre) RETURN g.name, avg(toInteger(s.duration)) AS avg_duration ORDER BY avg_duration DESC LIMIT 5;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (a:Actor)-[:ACTED_IN]->(m:Movie) RETURN a.name, COUNT(m) ORDER BY COUNT(m) DESC LIMIT 5;"
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test "MATCH (s:Show)-[:DIRECTED_BY]->(d:Director) RETURN d.name, COUNT(s) ORDER BY COUNT(s) DESC LIMIT 5;"
  
      - name: Save query results as CSV
        run: |
          cypher-shell -a bolt://localhost:7687 -u neo4j -p test --format plain \
            'MATCH (m:Movie) RETURN m.title, m.release_year;' > /tmp/neo4j_output.csv


     # - name: Run Neo4j script
      #  run: cypher-shell -a bolt://localhost:7687 -u neo4j -p test -f test_queries_neo4j.cql || \
          #   cypher-shell -a bolt://localhost:7687 -f test_queries_neo4j.cql

      - name: Upload Neo4j results
        uses: actions/upload-artifact@v4
        with:
          name: neo4j-output
          path: /tmp/neo4j_output.csv

